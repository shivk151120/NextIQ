{% extends 'core/base.html' %}
{% block content %}
<div class="container mx-auto px-4">

  <!-- Header -->
  <div class="flex justify-between items-center mb-6">
    <h3 class="text-2xl font-semibold">Student Dashboard</h3>
    <a href="{% url 'home' %}" class="text-gray-700 hover:text-gray-900 px-4 py-2 border border-gray-300 rounded">‚Üê Back</a>
  </div>

  <!-- Points and Belt / Progress -->
  <div class="grid grid-cols-1 lg:grid-cols-4 gap-6 mb-6">

    <!-- Points & Belt Card -->
    <div class="bg-white shadow-md rounded-lg p-5 flex flex-col justify-between">
      <div>
        <h5 class="text-lg font-medium">Your Points: <span class="inline-block bg-blue-500 text-white px-2 py-1 rounded">{{ total_points }}</span></h5>
        <h6 class="mt-3 text-md font-medium">Current Belt: <span class="inline-block bg-gray-800 text-white px-2 py-1 rounded">{{ current_belt }}</span></h6>
      </div>
      <button id="openLeaderboard" class="mt-4 bg-gray-100 text-gray-800 px-4 py-2 rounded hover:bg-gray-200 focus:outline-none">View Leaderboard</button>
    </div>

    <!-- Progress Chart Card -->
    <div class="lg:col-span-3 bg-white shadow-md rounded-lg p-5">
      <h5 class="text-lg font-medium mb-3">Your Progress</h5>
      <canvas id="progressChart" class="w-full h-64"></canvas>
    </div>
  </div>

  <!-- Practice Phrases -->
  <div class="bg-white shadow-md rounded-lg p-5">
    <h5 class="text-lg font-medium mb-3">Your Practice Phrases</h5>
    <ul class="divide-y divide-gray-200">
      {% for phrase in phrases %}
        <li class="flex justify-between items-center py-2">
          <span>{{ phrase.text }}</span>
          <a href="{% url 'practice' phrase.id %}" class="bg-blue-500 text-white px-3 py-1 rounded hover:bg-blue-600">Practice</a>
        </li>
      {% empty %}
        <li class="py-2 text-gray-500">No phrases available.</li>
      {% endfor %}
    </ul>
  </div>
</div>

<!-- Leaderboard Modal -->
<div id="leaderboardModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
  <div class="bg-white rounded-lg shadow-lg max-w-3xl w-full overflow-auto">
    <div class="flex justify-between items-center p-4 border-b">
      <h5 class="text-lg font-medium">Leaderboard</h5>
      <button id="closeLeaderboard" class="text-gray-600 hover:text-gray-800">&times;</button>
    </div>
    <div class="p-4">
      <table class="w-full table-auto border border-gray-200">
        <thead class="bg-gray-800 text-white">
          <tr>
            <th class="px-4 py-2">#</th>
            <th class="px-4 py-2">Student</th>
            <th class="px-4 py-2">Points</th>
            <th class="px-4 py-2">Belt</th>
          </tr>
        </thead>
        <tbody id="leaderRows" class="divide-y divide-gray-200"></tbody>
      </table>
    </div>
  </div>
</div>

<script>
// Leaderboard modal open/close
const leaderboardModal = document.getElementById('leaderboardModal');
document.getElementById('openLeaderboard').addEventListener('click', () => {
  leaderboardModal.classList.remove('hidden');
  fetch("{% url 'leaderboard_data' %}")
    .then(r => r.json())
    .then(({results}) => {
      const body = document.getElementById('leaderRows');
      body.innerHTML = "";
      results.forEach((row, idx) => {
        body.innerHTML += `
          <tr>
            <td class="px-4 py-2 text-center">${idx+1}</td>
            <td class="px-4 py-2">${row.username}</td>
            <td class="px-4 py-2 text-center">${row.points}</td>
            <td class="px-4 py-2 text-center"><span class="bg-gray-800 text-white px-2 py-1 rounded">${row.belt}</span></td>
          </tr>`;
      });
    });
});

document.getElementById('closeLeaderboard').addEventListener('click', () => {
  leaderboardModal.classList.add('hidden');
});

// Progress chart
const raw = [
  {% for a in attempts reversed %}
    {"d":"{{ a.attempt_date|date:'Y-m-d H:i' }}","c": {{ a.is_correct|yesno:"1,0" }}, "t":1},
  {% endfor %}
];

const labels = raw.map(x => x.d);
let cumCorrect = 0, cumTotal = 0;
const correctSeries = raw.map(x => { cumCorrect += x.c; return cumCorrect; });
const totalSeries   = raw.map(x => { cumTotal += x.t; return cumTotal; });

const ctx = document.getElementById('progressChart');
new Chart(ctx, {
  type: 'line',
  data: {
    labels,
    datasets: [
      { label: 'Correct (cumulative)', data: correctSeries, borderColor: 'rgb(34,197,94)', backgroundColor: 'rgba(34,197,94,0.2)', tension: 0.3 },
      { label: 'Attempts (cumulative)', data: totalSeries, borderColor: 'rgb(59,130,246)', backgroundColor: 'rgba(59,130,246,0.2)', tension: 0.3 }
    ]
  },
  options: {
    responsive: true,
    plugins: {
      legend: { position: 'top' }
    }
  }
});
</script>
{% endblock %}
